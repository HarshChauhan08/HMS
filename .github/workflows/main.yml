name: Branch Name and Code Review Validation

on:
  pull_request:
    types:
      - opened
      - synchronize

jobs:
  branchNameAndCodeReviewValidation:
    runs-on: ubuntu-latest

    steps:
      - name: Validate Branch Name
        run: |
          branch_name=$(echo "${{ github.head_ref }}" | awk -F '/' '{print $NF}')
          if [[ ! "$branch_name" =~ ^(FE|BE)-[0-9]+$ ]]; then
            echo "Invalid branch name format. Branch names must start with either 'FE-' or 'BE-' followed by a number."
            exit 1
          fi
      
      - name: Require Code Review Approval
        run: |
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            pull_number=$(jq --raw-output .pull_request.number "${{ github.event_path }}")
            response=$(curl -s -X GET \
              -H "Accept: application/vnd.github.v3+json" \
              -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
              "https://api.github.com/repos/${{ github.repository }}/pulls/${pull_number}/reviews")
            approvals=$(echo "$response" | jq '[.[] | select(.state == "APPROVED")] | length')
            if [[ "$approvals" -eq 1 ]]; then
              echo "Code review approval required before merging."
              exit 1
            fi
          fi
